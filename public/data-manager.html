<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Manager - CRISPR Student Portal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Global Styles - Matched to Main Page Theme (Gradients, Shadows, Segoe UI, Animations) */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); 
            color: #1f2937; 
            min-height: 100vh; 
            padding: 20px; 
            transition: all 0.3s ease; /* Smooth theme transitions */
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { 
            text-align: center; margin-bottom: 30px; 
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 50%, #ec4899 100%); /* Main page gradient */
            color: white; padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.3); /* Matched shadow */
            position: relative; overflow: hidden; 
            transform: skew(0deg); transition: transform 0.3s ease; /* Skew animation like tables */
        }
        .header:hover { transform: skew(-1deg); } /* Subtle hover animation */
        .header h1 { font-size: 28px; margin-bottom: 5px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .header p { font-size: 14px; opacity: 0.9; }
        .back-btn { 
            position: absolute; left: 20px; top: 20px; 
            background: rgba(255,255,255,0.2); border: none; color: white; 
            padding: 12px; border-radius: 50%; cursor: pointer; font-size: 18px; 
            transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.2); /* Main page button style */
            transform: skew(0deg);
        }
        .back-btn:hover { background: rgba(255,255,255,0.3); transform: skew(-2deg) translateY(-2px); }
        .tabs { 
            display: flex; background: white; border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 20px; 
            transform: skew(0deg); transition: transform 0.3s ease;
        }
        .tabs:hover { transform: skew(-1deg); }
        .tab-btn { 
            flex: 1; padding: 15px; background: none; border: none; 
            cursor: pointer; font-weight: 600; transition: all 0.3s ease; 
            border-bottom: 3px solid transparent; color: #6b7280;
        }
        .tab-btn:hover { color: #4f46e5; transform: translateY(-1px); }
        .tab-btn.active { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-bottom-color: #2563eb; color: #2563eb; }
        .tab-content { display: none; background: white; border-radius: 10px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .tab-content.active { display: block; transform: skew(1deg); } /* Skew for consistency */
        /* Upload Tab Styles */
        .upload-zone { 
            border: 2px dashed #cbd5e1; border-radius: 12px; padding: 40px; 
            text-align: center; cursor: pointer; transition: all 0.3s ease; 
            background: #f8fafc; margin-bottom: 20px; transform: skew(0deg);
        }
        .upload-zone:hover, .upload-zone.dragover { 
            border-color: #2563eb; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); 
            transform: skew(-1deg) scale(1.02);
        }
        .upload-zone i { font-size: 48px; color: #9ca3af; margin-bottom: 10px; transition: color 0.3s; }
        .upload-zone:hover i { color: #2563eb; }
        .upload-zone h3 { color: #4b5563; margin-bottom: 10px; }
        .upload-zone p { color: #6b7280; }
        .file-input { display: none; }
        .upload-btn { 
            background: linear-gradient(135deg, #2563eb, #7c3aed); color: white; 
            border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; 
            font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
            transform: skew(0deg);
        }
        .upload-btn:hover { transform: skew(-2deg) translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); }
        .upload-status { margin-top: 20px; padding: 10px; border-radius: 6px; display: none; font-weight: 500; }
        .upload-status.success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .upload-status.error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        /* Data Table Tab Styles */
        .data-table-wrapper { overflow-x: auto; }
        .table-controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        .filter-input { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; min-width: 200px; }
        .toggle-hide { background: #f3f4f6; border: 1px solid #d1d5db; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
        .toggle-hide:hover { background: #e5e7eb; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; transform: skew(0deg); transition: all 0.3s; }
        th { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.5px; }
        tr:hover { background: #f9fafb; transform: skew(-1deg); }
        tr.hidden { display: none; }
        .actions { display: flex; gap: 8px; }
        .btn { 
            padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; 
            font-size: 12px; font-weight: 600; transition: all 0.3s ease; 
            transform: skew(0deg);
        }
        .btn-view { background: #dbeafe; color: #1d4ed8; }
        .btn-edit { background: #fef3c7; color: #d97706; }
        .btn-delete { background: #fee2e2; color: #dc2626; }
        .btn:hover { transform: skew(-2deg) translateY(-1px); opacity: 0.9; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .readonly { background: #f9fafb; color: #6b7280; font-style: italic; }
        .no-data { text-align: center; padding: 40px; color: #6b7280; font-style: italic; }
        /* Max Totals Tab Styles */
        .max-totals-form { display: grid; gap: 15px; max-width: 600px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 5px; color: #374151; }
        .exam-row { display: flex; gap: 10px; align-items: center; padding: 10px; background: #f8fafc; border-radius: 6px; margin-bottom: 10px; }
        .exam-input { flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; }
        .remove-exam { background: #ef4444; color: white; border: none; padding: 6px; border-radius: 4px; cursor: pointer; }
        .add-exam-btn { background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .add-exam-btn:hover { background: #059669; transform: translateY(-1px); }
        /* Modals - Matched Animations */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 1000; animation: fadeIn 0.3s ease; 
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { 
            background: white; margin: 5% auto; padding: 30px; border-radius: 12px; 
            width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); transform: scale(0.9); 
            animation: slideIn 0.3s ease forwards; 
        }
        @keyframes slideIn { to { transform: scale(1); } }
        .close { float: right; font-size: 28px; cursor: pointer; color: #6b7280; transition: color 0.3s; }
        .close:hover { color: #374151; transform: rotate(90deg); }
        form { display: flex; flex-direction: column; gap: 15px; }
        input, select { padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; }
        input:focus { border-color: #2563eb; outline: none; }
        input[readonly] { background: #f3f4f6; color: #6b7280; cursor: not-allowed; }
        .save-btn { 
            background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px; border: none; 
            border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; 
            transform: skew(0deg);
        }
        .save-btn:hover { transform: skew(-2deg) translateY(-2px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        /* Responsive */
        @media (max-width: 768px) { 
            .tabs { flex-direction: column; } 
            .tab-btn { border-bottom: none; border-right: 3px solid transparent; } 
            .tab-btn.active { border-right-color: #2563eb; } 
            table { font-size: 12px; } 
            th, td { padding: 8px; } 
            .table-controls { flex-direction: column; align-items: stretch; }
            .filter-input { min-width: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-btn" onclick="window.location.href='index.html'" title="Back to Main Dashboard">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="header">
            <h1><i class="fas fa-database"></i> Data Manager</h1>
            <p>Manage student data uploads, edits, and exam configurations</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('upload')"><i class="fas fa-upload"></i> Upload CSV</button>
            <button class="tab-btn" onclick="switchTab('data')"><i class="fas fa-table"></i> View & Edit Data</button>
            <button class="tab-btn" onclick="switchTab('maxTotals')"><i class="fas fa-cog"></i> Exam Max Totals</button>
        </div>

        <!-- Upload Tab -->
        <div id="upload" class="tab-content active">
            <div class="upload-zone" id="uploadZone">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>Drop CSV file here or click to browse</h3>
                <p>Supports .csv files. This will replace the existing data.</p>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-folder-open"></i> Browse CSV Files
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".csv" />
            </div>
            <div id="uploadStatus" class="upload-status"></div>
        </div>

        <!-- Data View Tab -->
        <div id="data" class="tab-content">
            <div class="table-controls">
                <input type="text" id="examFilter" class="filter-input" placeholder="Filter by Exam Name..." oninput="applyFilters()">
                <input type="text" id="rollFilter" class="filter-input" placeholder="Filter by Roll Number..." oninput="applyFilters()">
                <select id="sortSelect" class="filter-input" onchange="applyFilters()">
                    <option value="roll-asc">Sort by Roll (A-Z)</option>
                    <option value="roll-desc">Sort by Roll (Z-A)</option>
                    <option value="exam-asc">Sort by Exam (A-Z)</option>
                    <option value="exam-desc">Sort by Exam (Z-A)</option>
                    <option value="total-desc">Sort by Total (High to Low)</option>
                </select>
                <button class="toggle-hide" id="toggleHide" onclick="toggleHiddenRows()">
                    <i class="fas fa-eye-slash"></i> Hide Unattempted (maxTotal=0)
                </button>
            </div>
            <div class="data-table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Roll</th>
                            <th>Name</th>
                            <th>Exam</th>
                            <th>Chem</th>
                            <th>Phy</th>
                            <th>Bio</th>
                            <th>Math</th>
                            <th>Total (Auto)</th>
                            <th>Percent (Auto)</th>
                            <th>Max Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dataTbody">
                        <tr><td colspan="11" class="no-data">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Max Totals Tab -->
        <div id="maxTotals" class="tab-content">
            <h3>Configure Max Scores per Exam</h3>
            <p>Add or edit max totals for each exam and subjects. These apply globally unless student maxTotal=0.</p>
            <button class="add-exam-btn" onclick="addExamRow()"><i class="fas fa-plus"></i> Add New Exam</button>
            <form id="maxTotalsForm" class="max-totals-form">
                <div id="examRows"></div>
                <button type="submit" class="save-btn"><i class="fas fa-save"></i> Save Configurations</button>
            </form>
        </div>
    </div>

    <!-- View Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('viewModal')">&times;</span>
            <h2><i class="fas fa-eye"></i> View Record</h2>
            <div id="viewContent"></div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editModal')">&times;</span>
            <h2><i class="fas fa-edit"></i> Edit Record</h2>
            <form id="editForm">
                <input type="hidden" id="editIndex">
                <input type="text" id="editRoll" placeholder="Roll" required>
                <input type="text" id="editName" placeholder="Name" required>
                <input type="text" id="editExam" placeholder="Exam" required>
                <input type="number" id="editChem" placeholder="Chemistry Score" min="0" required>
                <input type="number" id="editPhy" placeholder="Physics Score" min="0" required>
                <input type="number" id="editBio" placeholder="Biology Score" min="0" required>
                <input type="number" id="editMath" placeholder="Math Score" min="0" required>
                <input type="number" id="editTotal" placeholder="Total (Auto-calculated)" readonly class="readonly">
                <input type="number" id="editPercent" placeholder="Percent (Auto-calculated)" readonly class="readonly">
                <input type="number" id="editMaxTotal" placeholder="Max Total (Don't change if 0)" min="0">
                <button type="submit" class="save-btn">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Coming Soon Modal -->
<div id="comingSoonModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px; text-align: center;">
        <span class="close" onclick="closeComingSoonModal()" style="font-size: 28px; cursor: pointer; color: #6b7280; float: right; transition: color 0.3s;">&times;</span>
        <i class="fas fa-tools" style="font-size: 64px; color: #f59e0b; margin-bottom: 20px;"></i>
        <h2 style="color: #1f2937; margin-bottom: 10px; font-size: 24px;">Coming Soon!</h2>
        <p style="color: #6b7280; margin-bottom: 20px; font-size: 16px;">The Data Manager is under maintenance. We'll have full upload, edit, and config features ready shortly.</p>
        <p style="color: #10b981; font-weight: 600;">Stay tuned â€“ back in a flash! ðŸš€</p>
        <button onclick="closeComingSoonModal()" style="background: linear-gradient(135deg, #2563eb, #7c3aed); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 20px; transition: all 0.3s; transform: skew(0deg);">Got It</button>
    </div>
</div>

    <script>
        // Global Variables
        let allData = [];
        let filteredData = [];
        let hideUnattempted = true;
        let examMaxConfig = {}; // { 'WE 1': { maxTotal: 400, chem: 100, phy: 100, bio: 100, math: 100 } }

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            if (tabName === 'data') loadDataTable();
            if (tabName === 'maxTotals') loadExamMaxConfig();
        }

        // Drag & Drop Upload for CSV
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        async function handleFile(file) {
            if (!file.name.match(/\.csv$/)) {
                showStatus('Please select a CSV file (.csv)', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = async (e) => {
                const csvContent = e.target.result;
                const lines = csvContent.split('\n').map(line => line.split(',').map(cell => cell.trim().replace(/"/g, '')));
                const headers = lines[0];
                const jsonData = lines.slice(1).map(row => {
                    let obj = {};
                    headers.forEach((header, i) => obj[header] = row[i] || '');
                    return obj;
                }).filter(row => row.roll && row.name); // Filter valid rows
                
                // Send to backend
                try {
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ data: jsonData, format: 'csv' })
                    });
                    if (response.ok) {
                        showStatus('CSV uploaded and replaced successfully! Refresh the main page to see changes.', 'success');
                        loadDataTable(); // Reload table if on data tab
                    } else {
                        throw new Error('Upload failed');
                    }
                } catch (err) {
                    showStatus('Upload error: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function showStatus(message, type) {
            const status = document.getElementById('uploadStatus');
            status.textContent = message;
            status.className = `upload-status ${type}`;
            status.style.display = 'block';
            if (type === 'success') setTimeout(() => status.style.display = 'none', 5000);
        }

        // Load Data Table with Filters/Sort/Hide
        async function loadDataTable() {
            try {
                const response = await fetch('/api/students');
                const result = await response.json();
                allData = result.data || [];
                filteredData = [...allData];
                renderTable();
                applyFilters(); // Initial apply
            } catch (err) {
                document.getElementById('dataTbody').innerHTML = '<tr><td colspan="11" class="no-data">Error loading data</td></tr>';
                console.error('Load error:', err);
            }
        }

        function renderTable() {
            const tbody = document.getElementById('dataTbody');
            tbody.innerHTML = filteredData.length === 0 
                ? '<tr><td colspan="11" class="no-data">No data available</td></tr>'
                : filteredData.map((row, index) => {
                    const globalIndex = allData.indexOf(row); // For actions
                    const isHidden = hideUnattempted && parseInt(row.maxTotal) === 0;
                    return `
                        <tr ${isHidden ? 'class="hidden"' : ''}>
                            <td>${row.roll || ''}</td>
                            <td>${row.name || ''}</td>
                            <td>${row.exam || ''}</td>
                            <td>${row.chem || 0}</td>
                            <td>${row.phy || 0}</td>
                            <td>${row.bio || 0}</td>
                            <td>${row.math || 0}</td>
                            <td class="readonly">${(parseInt(row.chem || 0) + parseInt(row.phy || 0) + parseInt(row.bio || 0) + parseInt(row.math || 0))}</td>
                            <td class="readonly">${row.maxTotal ? (parseInt(row.total || 0) / parseInt(row.maxTotal) * 100).toFixed(2) : 'N/A'}%</td>
                            <td>${row.maxTotal || 0}</td>
                            <td>
                                <div class="actions">
                                    <button class="btn btn-view" onclick="viewRecord(${globalIndex})" ${isHidden ? 'disabled' : ''}><i class="fas fa-eye"></i></button>
                                    <button class="btn btn-edit" onclick="editRecord(${globalIndex})" ${isHidden ? 'disabled' : ''}><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-delete" onclick="deleteRecord(${globalIndex})" ${isHidden ? 'disabled' : ''}><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
        }

        function applyFilters() {
            const examFilter = document.getElementById('examFilter').value.toLowerCase();
            const rollFilter = document.getElementById('rollFilter').value.toLowerCase();
            const sortValue = document.getElementById('sortSelect').value;

            filteredData = allData.filter(row => 
                (!examFilter || row.exam.toLowerCase().includes(examFilter)) &&
                (!rollFilter || row.roll.toLowerCase().includes(rollFilter))
            );

            // Sort
            filteredData.sort((a, b) => {
                let valA, valB;
                if (sortValue.includes('roll')) {
                    valA = a.roll; valB = b.roll;
                    return sortValue.endsWith('asc') ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else if (sortValue.includes('exam')) {
                    valA = a.exam; valB = b.exam;
                    return sortValue.endsWith('asc') ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else if (sortValue.includes('total')) {
                    valA = parseInt(a.total || 0); valB = parseInt(b.total || 0);
                    return valB - valA; // Desc by default
                }
                return 0;
            });

            renderTable();
        }

        function toggleHiddenRows() {
            hideUnattempted = !hideUnattempted;
            const btn = document.getElementById('toggleHide');
            btn.innerHTML = hideUnattempted ? '<i class="fas fa-eye-slash"></i> Hide Unattempted' : '<i class="fas fa-eye"></i> Show All';
            renderTable();
        }

        // View Record
        function viewRecord(index) {
            const row = allData[index];
            const total = parseInt(row.chem || 0) + parseInt(row.phy || 0) + parseInt(row.bio || 0) + parseInt(row.math || 0);
            const percent = row.maxTotal ? (total / parseInt(row.maxTotal) * 100).toFixed(2) : 'N/A';
            document.getElementById('viewContent').innerHTML = `
                <p><strong>Roll:</strong> ${row.roll}</p>
                <p><strong>Name:</strong> ${row.name}</p>
                <p><strong>Exam:</strong> ${row.exam}</p>
                <p><strong>Scores:</strong> Chem: ${row.chem}, Phy: ${row.phy}, Bio: ${row.bio}, Math: ${row.math}</p>
                <p><strong>Total:</strong> ${total} / ${row.maxTotal || 0} (${percent}%)</p>
            `;
            document.getElementById('viewModal').style.display = 'block';
        }

        // Edit Record (Auto-calc total/percent, preserve maxTotal=0)
        function editRecord(index) {
            const row = allData[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('editRoll').value = row.roll || '';
            document.getElementById('editName').value = row.name || '';
            document.getElementById('editExam').value = row.exam || '';
            document.getElementById('editChem').value = row.chem || 0;
            document.getElementById('editPhy').value = row.phy || 0;
            document.getElementById('editBio').value = row.bio || 0;
            document.getElementById('editMath').value = row.math || 0;
            // Auto-calc
            updateAutoCalc();
            document.getElementById('editMaxTotal').value = row.maxTotal || 0;
            document.getElementById('editModal').style.display = 'block';
        }

        // Auto-calc on subject input change
        ['editChem', 'editPhy', 'editBio', 'editMath'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateAutoCalc);
        });

        function updateAutoCalc() {
            const chem = parseInt(document.getElementById('editChem').value) || 0;
            const phy = parseInt(document.getElementById('editPhy').value) || 0;
            const bio = parseInt(document.getElementById('editBio').value) || 0;
            const math = parseInt(document.getElementById('editMath').value) || 0;
            const total = chem + phy + bio + math;
            const maxTotal = parseInt(document.getElementById('editMaxTotal').value) || 0;
            document.getElementById('editTotal').value = total;
            document.getElementById('editPercent').value = maxTotal > 0 ? (total / maxTotal * 100).toFixed(2) : 'N/A';
        }

        // Save Edit (Update CSV, preserve all data)
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const index = parseInt(document.getElementById('editIndex').value);
            const maxTotal = parseInt(allData[index].maxTotal || 0); // Preserve original if 0
            const updatedRow = {
                roll: document.getElementById('editRoll').value,
                name: document.getElementById('editName').value,
                exam: document.getElementById('editExam').value,
                chem: parseInt(document.getElementById('editChem').value) || 0,
                phy: parseInt(document.getElementById('editPhy').value) || 0,
                bio: parseInt(document.getElementById('editBio').value) || 0,
                math: parseInt(document.getElementById('editMath').value) || 0,
                total: document.getElementById('editTotal').value, // Auto
                percent: document.getElementById('editPercent').value.replace('%', ''), // Auto
                maxTotal: maxTotal === 0 ? 0 : (parseInt(document.getElementById('editMaxTotal').value) || maxTotal), // Preserve 0
                maxChem: 100, maxPhy: 100, maxBio: 100, maxMath: 100 // Defaults
            };
            try {
                const response = await fetch('/api/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index, data: updatedRow })
                });
                if (response.ok) {
                    closeModal('editModal');
                    loadDataTable();  // Reload to reflect changes
                } else {
                    alert('Update failed');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        });

        // Delete Record (Preserves others)
        async function deleteRecord(index) {
            if (!confirm('Delete this record? This will not affect other data.')) return;
            try {
                const response = await fetch('/api/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index })
                });
                if (response.ok) {
                    loadDataTable();  // Reload
                } else {
                    alert('Delete failed');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Max Totals Tab
        function loadExamMaxConfig() {
            // Fetch or load config (for now, derive from data)
            const uniqueExams = [...new Set(allData.map(d => d.exam).filter(Boolean))];
            const rows = document.getElementById('examRows');
            rows.innerHTML = uniqueExams.map(exam => `
                <div class="exam-row">
                    <input type="text" class="exam-input" value="${exam}" readonly>
                    <input type="number" class="exam-input" placeholder="Max Total" id="maxTotal_${exam.replace(/\s+/g, '_')}" value="${examMaxConfig[exam]?.maxTotal || 400}">
                    <input type="number" class="exam-input" placeholder="Chem Max" value="${examMaxConfig[exam]?.chem || 100}">
                    <input type="number" class="exam-input" placeholder="Phy Max" value="${examMaxConfig[exam]?.phy || 100}">
                    <input type="number" class="exam-input" placeholder="Bio Max" value="${examMaxConfig[exam]?.bio || 100}">
                    <input type="number" class="exam-input" placeholder="Math Max" value="${examMaxConfig[exam]?.math || 100}">
                    <button type="button" class="remove-exam" onclick="removeExamRow(this)">Ã—</button>
                </div>
            `).join('');
            if (uniqueExams.length === 0) rows.innerHTML = '<p class="no-data">No exams found. Upload data first.</p>';
        }

        function addExamRow() {
            const examName = prompt('Enter exam name (e.g., WE 1):');
            if (!examName) return;
            const rows = document.getElementById('examRows');
            const newRow = document.createElement('div');
            newRow.className = 'exam-row';
            newRow.innerHTML = `
                <input type="text" class="exam-input" value="${examName}" id="examName_${Date.now()}">
                <input type="number" class="exam-input" placeholder="Max Total" value="400">
                <input type="number" class="exam-input" placeholder="Chem Max" value="100">
                <input type="number" class="exam-input" placeholder="Phy Max" value="100">
                <input type="number" class="exam-input" placeholder="Bio Max" value="100">
                <input type="number" class="exam-input" placeholder="Math Max" value="100">
                <button type="button" class="remove-exam" onclick="removeExamRow(this)">Ã—</button>
            `;
            rows.appendChild(newRow);
        }

        function removeExamRow(btn) {
            if (confirm('Remove this exam config?')) btn.closest('.exam-row').remove();
        }

        document.getElementById('maxTotalsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const rows = document.querySelectorAll('.exam-row');
            const config = {};
            rows.forEach(row => {
                const exam = row.querySelector('input[type="text"]').value;
                if (exam) {
                    config[exam] = {
                        maxTotal: parseInt(row.querySelectorAll('input[type="number"]')[0].value) || 400,
                        chem: parseInt(row.querySelectorAll('input[type="number"]')[1].value) || 100,
                        phy: parseInt(row.querySelectorAll('input[type="number"]')[2].value) || 100,
                        bio: parseInt(row.querySelectorAll('input[type="number"]')[3].value) || 100,
                        math: parseInt(row.querySelectorAll('input[type="number"]')[4].value) || 100
                    };
                }
            });
            try {
                const response = await fetch('/api/config-max', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ config })
                });
                if (response.ok) {
                    examMaxConfig = config;
                    alert('Configurations saved! Update student maxTotals via edits if needed.');
                } else {
                    alert('Save failed');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        });

        // Modal Controls
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        window.onclick = (e) => {
            if (e.target.classList.contains('modal')) {
                const modalId = e.target.id;
                closeModal(modalId);
            }
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadDataTable();
        });
    </script>
</body>
</html>